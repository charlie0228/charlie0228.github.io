{"_path":"/post/20260120-lucene-parser-vs-regex-validation","_dir":"post","_draft":false,"_partial":false,"_locale":"","title":"從 100 行 Regex 到 Lucene Parser：複雜驗證邏輯的重構之路","description":"最近在維護一個關鍵字搜尋功能時，遇到了一個經典的工程問題：手寫的 Regex 驗證邏輯越來越難維護，每次修 bug 都像在拆炸彈。","tags":"lucene, parser, regex, validation, typescript, javascript, ast, peg.js","createdByAI":true,"readingTime":{"text":"12 min read","minutes":11.315,"time":678900,"words":2263},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最近在維護一個關鍵字搜尋功能時，遇到了一個經典的工程問題：手寫的 Regex 驗證邏輯越來越難維護，每次修 bug 都像在拆炸彈。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這篇文章記錄了我如何從「純 Regex 驗證」重構到「Parser + AST 驗證」的過程，以及這兩種方法的優缺點比較。"}]},{"type":"element","tag":"h2","props":{"id":"問題背景"},"children":[{"type":"text","value":"問題背景"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們的系統允許使用者輸入布林搜尋語法來篩選產品，支援 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AND"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"OR"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NOT"}]},{"type":"text","value":" 運算子和括號分組："}]},{"type":"element","tag":"pre","props":{"code":"(星冰樂 OR 那堤 OR 咖啡) AND (NOT (冷萃 OR 巧克力))\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"(星冰樂 OR 那堤 OR 咖啡) AND (NOT (冷萃 OR 巧克力))\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個輸入會被送到後端，轉換成 BigQuery 的 Regex 進行資料篩選。前端的職責是在送出前驗證格式是否正確，給使用者友善的錯誤提示。"}]},{"type":"element","tag":"h3","props":{"id":"原本的-regex-驗證"},"children":[{"type":"text","value":"原本的 Regex 驗證"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最初的實作是用一連串的 Regex 來檢查各種規則："}]},{"type":"element","tag":"pre","props":{"code":"function validateKeywordsFormat(input: string): string | null {\n  const trimmedInput = input.trim()\n\n  // 檢查是否為空\n  if (!trimmedInput) {\n    return '請輸入關鍵字'\n  }\n\n  // 檢查括號是否配對\n  let parenthesesCount = 0\n  for (const char of trimmedInput) {\n    if (char === '(') parenthesesCount++\n    if (char === ')') parenthesesCount--\n    if (parenthesesCount < 0) return '括號配對錯誤'\n  }\n  if (parenthesesCount !== 0) return '括號配對錯誤'\n\n  // 檢查邏輯運算子格式（必須為大寫）\n  if (/\\b(?:and|not|or)\\b/i.test(trimmedInput)) {\n    return '邏輯運算子必須使用大寫：AND、NOT、OR'\n  }\n\n  // 檢查運算子前後是否有適當的空白\n  if (/(?:^|\\S)\\b(?:AND|NOT|OR)\\b(?:\\S|$)/.test(trimmedInput)) {\n    return '邏輯運算子前後必須有空白間隔'\n  }\n\n  // 檢查 AND/OR 不能緊接在左括號後面\n  if (/\\(\\s*(?:AND|OR)\\b/.test(trimmedInput)) {\n    return 'AND/OR 運算子前面必須有運算元'\n  }\n\n  // ... 還有更多規則\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" validateKeywordsFormat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" | "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"trim"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 檢查是否為空\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '請輸入關鍵字'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 檢查括號是否配對\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  let"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" parenthesesCount"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" char"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" of"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"char"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '('"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"parenthesesCount"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"++\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"char"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" ')'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"parenthesesCount"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"--\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"parenthesesCount"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" <"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '括號配對錯誤'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"parenthesesCount"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" !=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '括號配對錯誤'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 檢查邏輯運算子格式（必須為大寫）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:and"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"not"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"or)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '邏輯運算子必須使用大寫：AND、NOT、OR'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 檢查運算子前後是否有適當的空白\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/(?:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\S)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"NOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:\\S"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":")/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '邏輯運算子前後必須有空白間隔'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 檢查 AND/OR 不能緊接在左括號後面\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"\\("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'AND/OR 運算子前面必須有運算元'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // ... 還有更多規則\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這段程式碼大約 100 行，看起來還算清晰。但問題來了。"}]},{"type":"element","tag":"h2","props":{"id":"踩到的坑"},"children":[{"type":"text","value":"踩到的坑"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"某天 QA 回報了一個 bug："}]},{"type":"element","tag":"pre","props":{"code":"輸入：(星冰樂 OR 那堤) AND (NOT (冷萃 OR 巧克力))\n錯誤訊息：關鍵字中的邏輯運算子前後必須使用底線，例：hello_NOT_world\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"輸入：(星冰樂 OR 那堤) AND (NOT (冷萃 OR 巧克力))\n錯誤訊息：關鍵字中的邏輯運算子前後必須使用底線，例：hello_NOT_world\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這明明是合法的輸入，為什麼會報錯？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"追查後發現，問題出在這段 Regex："}]},{"type":"element","tag":"pre","props":{"code":"const operatorWithoutSpaces = /(?:^|\\S)\\b(?:AND|NOT|OR)\\b(?:\\S|$)/.test(trimmedInput)\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" operatorWithoutSpaces"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" /(?:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\S)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"NOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:\\S"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":")/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個 Regex 的意圖是「檢查運算子前後是否緊鄰非空白字元」，但它把 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"(NOT"}]},{"type":"text","value":" 中的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"("}]},{"type":"text","value":" 也當成了「非空白字元」，導致誤判。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"修復很簡單，把 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\\S"}]},{"type":"text","value":" 改成 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"[^\\s(]"}]},{"type":"text","value":" 就好："}]},{"type":"element","tag":"pre","props":{"code":"const operatorWithoutSpaces = /(?:^|[^\\s(])\\b(?:AND|NOT|OR)\\b(?:[^\\s)]|$)/.test(trimmedInput)\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" operatorWithoutSpaces"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" /(?:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"(]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"NOT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":")]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":")/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"但這只是開始。接著又發現 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶 (AND 水)"}]},{"type":"text","value":" 這種格式沒有被擋住（"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AND"}]},{"type":"text","value":" 前面應該要有運算元）。於是又加了一條規則："}]},{"type":"element","tag":"pre","props":{"code":"if (/\\(\\s*(?:AND|OR)\\b/.test(trimmedInput)) {\n  return 'AND/OR 運算子前面必須有運算元'\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"\\("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmedInput"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'AND/OR 運算子前面必須有運算元'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然後又發現 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"hello_AND_world"}]},{"type":"text","value":" 這種底線包圍的情況被誤判..."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"每次修一個 bug，就可能引入另一個 bug。這就是 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Regex 地獄"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"h2","props":{"id":"為什麼-regex-不適合這種場景"},"children":[{"type":"text","value":"為什麼 Regex 不適合這種場景？"}]},{"type":"element","tag":"h3","props":{"id":"_1-regex-無法處理巢狀結構"},"children":[{"type":"text","value":"1. Regex 無法處理巢狀結構"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Regex 是為「正規語言」(Regular Language) 設計的，而我們的查詢語法包含巢狀括號，這屬於「上下文無關語言」(Context-Free Language)"},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-1","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-1"},"children":[{"type":"text","value":"1"}]}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"理論上，Regex 無法正確處理任意深度的巢狀結構。雖然現代 Regex 引擎有一些擴充功能（如遞迴匹配），但這會讓 Regex 變得極其複雜。"}]},{"type":"element","tag":"h3","props":{"id":"_2-規則之間會互相干擾"},"children":[{"type":"text","value":"2. 規則之間會互相干擾"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"當你有 10 條以上的 Regex 規則時，它們之間的執行順序和邊界條件會變得很難追蹤。一個規則的修改可能會影響其他規則的行為。"}]},{"type":"element","tag":"h3","props":{"id":"_3-錯誤訊息難以精確"},"children":[{"type":"text","value":"3. 錯誤訊息難以精確"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Regex 只能告訴你「匹配」或「不匹配」，很難提供精確的錯誤位置和原因。"}]},{"type":"element","tag":"h3","props":{"id":"_4-測試覆蓋困難"},"children":[{"type":"text","value":"4. 測試覆蓋困難"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"要確保所有邊界案例都被正確處理，需要大量的測試案例。而且每次修改都要重新驗證所有案例。"}]},{"type":"element","tag":"h2","props":{"id":"解決方案使用-parser"},"children":[{"type":"text","value":"解決方案：使用 Parser"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"既然我們的語法本質上是 Lucene Query Syntax 的子集，為什麼不直接用現成的 Parser？"}]},{"type":"element","tag":"h3","props":{"id":"lucene-套件"},"children":[{"type":"text","value":"lucene 套件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"lucene"}]},{"type":"text","value":" 是一個 npm 套件，使用 PEG.js"},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-2","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-2"},"children":[{"type":"text","value":"2"}]}]},{"type":"text","value":" 生成的 Parser 來解析 Lucene 查詢語法。它會把輸入字串轉換成 AST (Abstract Syntax Tree)："}]},{"type":"element","tag":"pre","props":{"code":"import lucene from 'lucene'\n\nconst ast = lucene.parse('茶 AND 水')\nconsole.log(ast)\n// {\n//   left: { field: '<implicit>', term: '茶', ... },\n//   operator: 'AND',\n//   right: { field: '<implicit>', term: '水', ... }\n// }\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" lucene"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'lucene'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" ast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" lucene"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'茶 AND 水'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"console"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"ast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"//   left: { field: '<implicit>', term: '茶', ... },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"//   operator: 'AND',\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"//   right: { field: '<implicit>', term: '水', ... }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// }\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"新的驗證架構"},"children":[{"type":"text","value":"新的驗證架構"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"重構後的驗證邏輯分成三層："}]},{"type":"element","tag":"pre","props":{"code":"function validateKeywordsFormat(input: string): string | null {\n  const trimmed = input.trim()\n\n  // 1. 空值檢查\n  if (!trimmed) return '請輸入關鍵字'\n\n  // 2. 預檢查（Parser 無法處理的規則）\n  const preError = preValidateKeywords(trimmed)\n  if (preError) return preError\n\n  // 3. Parser 解析\n  let ast: AST\n  try {\n    ast = lucene.parse(trimmed)\n  } catch {\n    return '關鍵字語法錯誤，請檢查括號配對與運算子使用'\n  }\n\n  // 4. AST 驗證（檢查不允許的特性）\n  const featureError = checkDisallowedFeatures(ast)\n  if (featureError) return featureError\n\n  // 5. Term 格式檢查\n  const terms = collectTerms(ast)\n  for (const { term } of terms) {\n    if (/_{2,}/.test(term)) return '請避免使用連續的底線'\n    // ... 其他檢查\n  }\n\n  return null\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" validateKeywordsFormat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" | "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" trimmed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"trim"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 1. 空值檢查\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '請輸入關鍵字'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 2. 預檢查（Parser 無法處理的規則）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" preError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" preValidateKeywords"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"preError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" preError\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 3. Parser 解析\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  let"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" ast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"AST\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  try"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"    ast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" lucene"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"parse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"trimmed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"catch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '關鍵字語法錯誤，請檢查括號配對與運算子使用'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 4. AST 驗證（檢查不允許的特性）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" featureError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" checkDisallowedFeatures"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"ast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"featureError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" featureError\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 5. Term 格式檢查\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" terms"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" collectTerms"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"ast"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"term"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"of"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" terms"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/_"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"{2,}"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"term"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '請避免使用連續的底線'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // ... 其他檢查\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" null\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"預檢查parser-無法處理的規則"},"children":[{"type":"text","value":"預檢查：Parser 無法處理的規則"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"有些規則是我們自訂的，Lucene Parser 不會報錯，需要在 Parse 之前用 Regex 檢查："}]},{"type":"element","tag":"pre","props":{"code":"function preValidateKeywords(input: string): string | null {\n  // 小寫運算子（lucene 會把 'and' 當成關鍵字，不會報錯）\n  if (/(?:^|\\s)(?:and|or|not)(?:\\s|$)/.test(input)) {\n    return '邏輯運算子必須使用大寫：AND、NOT、OR'\n  }\n\n  // 運算子結尾（lucene 允許，但我們不允許）\n  if (/\\b(?:AND|OR|NOT)\\s*$/.test(input)) {\n    return '表達式不能以邏輯運算子結尾'\n  }\n\n  // 連續運算子\n  if (/\\b(?:AND|OR|NOT)\\s+(?:AND|OR|NOT)\\b/.test(input)) {\n    return '不能有連續的邏輯運算子'\n  }\n\n  return null\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" preValidateKeywords"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" | "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 小寫運算子（lucene 會把 'and' 當成關鍵字，不會報錯）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/(?:"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"^"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"\\s)(?:and"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"or"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"not)(?:\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":")/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '邏輯運算子必須使用大寫：AND、NOT、OR'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 運算子結尾（lucene 允許，但我們不允許）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"NOT)\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '表達式不能以邏輯運算子結尾'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 連續運算子\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"NOT)\\s"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"(?:AND"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"OR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"NOT)"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"\\b"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"/"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"test"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '不能有連續的邏輯運算子'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" null\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"ast-驗證遍歷語法樹"},"children":[{"type":"text","value":"AST 驗證：遍歷語法樹"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parser 成功後，我們可以遍歷 AST 來檢查更複雜的規則："}]},{"type":"element","tag":"pre","props":{"code":"function checkDisallowedFeatures(node: AST | Node): string | null {\n  function traverse(n: unknown): string | null {\n    if (!n || typeof n !== 'object') return null\n    const obj = n as Record<string, unknown>\n\n    // 檢查萬用字元（* 或 ?）\n    if ('term' in obj && typeof obj.term === 'string') {\n      if (obj.term.includes('*') || obj.term.includes('?')) {\n        return '不支援萬用字元（* 或 ?）'\n      }\n    }\n\n    // 檢查 AND/OR 開頭（AST 中會有 start 屬性）\n    if ('start' in obj && (obj.start === 'AND' || obj.start === 'OR')) {\n      return '表達式不能以 AND 或 OR 開頭'\n    }\n\n    // 遞迴檢查子節點\n    const leftError = 'left' in obj ? traverse(obj.left) : null\n    if (leftError) return leftError\n\n    const rightError = 'right' in obj ? traverse(obj.right) : null\n    if (rightError) return rightError\n\n    return null\n  }\n\n  return traverse(node)\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" checkDisallowedFeatures"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"AST"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" | "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"Node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" | "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" traverse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"unknown"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" | "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ||"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" typeof"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" !=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'object'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" null\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" Record"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"unknown"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 檢查萬用字元（* 或 ?）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'term'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" &&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" typeof"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"term"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'string'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"      if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"term"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"includes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'*'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"||"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"term"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"includes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'?'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '不支援萬用字元（* 或 ?）'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"      }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 檢查 AND/OR 開頭（AST 中會有 start 屬性）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'start'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" &&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"start"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'AND'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ||"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"start"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'OR'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"      return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '表達式不能以 AND 或 OR 開頭'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 遞迴檢查子節點\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" leftError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'left'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" ?"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" traverse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"left"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" null\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"leftError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" leftError\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" rightError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'right'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" ?"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" traverse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"obj"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"right"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" null\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"rightError"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" rightError\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" null\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" traverse"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"兩種方法的比較"},"children":[{"type":"text","value":"兩種方法的比較"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"面向"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"純 Regex"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"Parser + AST"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"程式碼量"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"~100 行"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"~150 行"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可讀性"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"低（Regex 難讀）"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"高（結構清晰）"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"維護性"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"低（規則互相干擾）"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"高（分層處理）"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"擴充性"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"低（新規則可能破壞舊規則）"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"高（新規則獨立）"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"錯誤處理"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"粗糙"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"精確"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"效能"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"快"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"稍慢（但可忽略）"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"依賴"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"無"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"需要 lucene 套件"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"最終的驗證規則"},"children":[{"type":"text","value":"最終的驗證規則"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"重構後，我們的驗證涵蓋了 12 條規則："}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"#"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"規則"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"錯誤範例"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"錯誤訊息"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"空值"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"\"\""}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"請輸入關鍵字"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"括號配對"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"((茶)"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"關鍵字語法錯誤，請檢查括號配對與運算子使用"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"空括號"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶 AND ()"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"同上"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"小寫運算子"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶 and 水"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"邏輯運算子必須使用大寫：AND、NOT、OR"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"運算子前後缺空白"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶AND水"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"邏輯運算子前後必須有空白間隔"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"6"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"AND/OR 開頭"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"AND 茶"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"表達式不能以 AND 或 OR 開頭"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"7"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"括號內 AND/OR 開頭"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"(AND 茶)"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"同上"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"8"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"運算子結尾"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶 AND"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"表達式不能以邏輯運算子結尾"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"9"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"連續運算子"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶 AND AND 水"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"不能有連續的邏輯運算子"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"10"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"關鍵字內含運算子"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"helloANDworld"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"邏輯運算子前後必須有空白間隔"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"11"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"連續底線"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"test__keyword"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"請避免使用連續的底線"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"12"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"萬用字元"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶*"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"不支援萬用字元（* 或 ?）"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"為什麼要擋萬用字元"},"children":[{"type":"text","value":"為什麼要擋萬用字元？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個規則值得特別說明。Lucene 原生支援萬用字元語法："},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶*"}]},{"type":"text","value":" 表示「以茶開頭的任意字串」，"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶?"}]},{"type":"text","value":" 表示「茶後面接一個任意字元」。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"但我們的系統不支援這個功能——輸入 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶*"}]},{"type":"text","value":" 時，系統只會把它當成字面上的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"茶*"}]},{"type":"text","value":" 去搜尋，不會展開成萬用字元匹配。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果不擋這個語法，使用者可能會誤以為系統支援萬用字元搜尋，輸入 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"咖啡*"}]},{"type":"text","value":" 期待搜到「咖啡豆」、「咖啡粉」等結果，但實際上只會搜到品名剛好是 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"咖啡*"}]},{"type":"text","value":" 的產品（如果有的話）。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"為了避免這種認知落差，我們選擇在前端直接擋掉，並給出明確的錯誤訊息。"}]},{"type":"element","tag":"h2","props":{"id":"結論"},"children":[{"type":"text","value":"結論"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這次重構讓我深刻體會到："},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"選擇正確的工具比硬幹重要"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Regex 很強大，但它有適用範圍。當你發現自己在寫第 10 條 Regex 規則，而且每次修改都要擔心會不會破壞其他規則時，就該考慮換個方法了。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parser 的學習曲線稍高，但它提供了："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"結構化的資料"}]},{"type":"text","value":"：AST 讓你可以用程式邏輯來處理，而不是用 Regex 猜測"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"清晰的分層"}]},{"type":"text","value":"：預檢查、解析、AST 驗證各司其職"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"更好的錯誤處理"}]},{"type":"text","value":"：Parser 的錯誤訊息通常比 Regex 更有意義"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"下次遇到類似的驗證需求，不妨先問自己：這個語法有多複雜？有沒有現成的 Parser 可以用？"}]},{"type":"element","tag":"h2","props":{"id":"環境資訊"},"children":[{"type":"text","value":"環境資訊"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Node.js: v22.16.0"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"TypeScript: 5.x"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lucene: 2.1.1"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"本文撰寫時間：2026 年 1 月，技術版本可能隨時間更新，請以官方文件為準。"}]}]},{"type":"element","tag":"section","props":{"className":["footnotes"],"dataFootnotes":""},"children":[{"type":"element","tag":"h2","props":{"className":["sr-only"],"id":"footnote-label"},"children":[{"type":"text","value":"Reference"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{"id":"user-content-fn-1"},"children":[{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Chomsky_hierarchy","rel":["nofollow"]},"children":[{"type":"text","value":"Chomsky hierarchy - Wikipedia"}]},{"type":"text","value":" - 正規語言是 Chomsky 階層中最簡單的一層，無法表達巢狀結構。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-1","ariaLabel":"Back to reference 1","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]},{"type":"element","tag":"li","props":{"id":"user-content-fn-2"},"children":[{"type":"element","tag":"a","props":{"href":"https://pegjs.org/","rel":["nofollow"]},"children":[{"type":"text","value":"PEG.js"}]},{"type":"text","value":" - 一個 JavaScript 的 Parser Generator，lucene 套件使用它來生成 Lucene Query Parser。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-2","ariaLabel":"Back to reference 2","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"問題背景","depth":2,"text":"問題背景","children":[{"id":"原本的-regex-驗證","depth":3,"text":"原本的 Regex 驗證"}]},{"id":"踩到的坑","depth":2,"text":"踩到的坑"},{"id":"為什麼-regex-不適合這種場景","depth":2,"text":"為什麼 Regex 不適合這種場景？","children":[{"id":"_1-regex-無法處理巢狀結構","depth":3,"text":"1. Regex 無法處理巢狀結構"},{"id":"_2-規則之間會互相干擾","depth":3,"text":"2. 規則之間會互相干擾"},{"id":"_3-錯誤訊息難以精確","depth":3,"text":"3. 錯誤訊息難以精確"},{"id":"_4-測試覆蓋困難","depth":3,"text":"4. 測試覆蓋困難"}]},{"id":"解決方案使用-parser","depth":2,"text":"解決方案：使用 Parser","children":[{"id":"lucene-套件","depth":3,"text":"lucene 套件"},{"id":"新的驗證架構","depth":3,"text":"新的驗證架構"},{"id":"預檢查parser-無法處理的規則","depth":3,"text":"預檢查：Parser 無法處理的規則"},{"id":"ast-驗證遍歷語法樹","depth":3,"text":"AST 驗證：遍歷語法樹"}]},{"id":"兩種方法的比較","depth":2,"text":"兩種方法的比較"},{"id":"最終的驗證規則","depth":2,"text":"最終的驗證規則"},{"id":"為什麼要擋萬用字元","depth":2,"text":"為什麼要擋萬用字元？"},{"id":"結論","depth":2,"text":"結論"},{"id":"環境資訊","depth":2,"text":"環境資訊"},{"id":"footnote-label","depth":2,"text":"Reference"}]}},"_type":"markdown","_id":"content:post:20260120-lucene-parser-vs-regex-validation.md","_source":"content","_file":"post/20260120-lucene-parser-vs-regex-validation.md","_extension":"md","createdAt":"2026-01-20T04:52:18.000Z","updatedAt":"2026-01-20T04:52:18.000Z"}