{"_path":"/post/20260106-nodejs-oom-stream-optimization","_dir":"post","_draft":false,"_partial":false,"_locale":"","title":"在 Cloud Run 被 OOM 教訓的一課：用 Stream 把記憶體從 O(N) 降到 O(1)","description":"2026 年剛開始，我就收到了一份「大禮」。","tags":"node.js, oom, memory leak, cloud run, stream, bigquery, javascript, typescript","customCreatedAt":"2026-01-06T00:00:00.000Z","createdByAI":true,"readingTime":{"text":"11 min read","minutes":10.6,"time":636000,"words":2120},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2026 年剛開始，我就收到了一份「大禮」。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"公司內部有一個負責上傳資料到外部數據平台 (Data Partner) 的排程任務，在 Local 開發時測試幾萬筆資料都跑得好好的，結果一上線遇到 150 萬筆資料的大報表，服務直接炸開。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"GCP Log 上出現了令人絕望的 Fatal Error："}]},{"type":"element","tag":"pre","props":{"code":"FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這篇文章記錄了這次從記憶體崩潰到修復，以及最後發現架構上盲點的除錯過程。"}]},{"type":"element","tag":"h2","props":{"id":"案發經過"},"children":[{"type":"text","value":"案發經過"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們的任務很單純：從 BigQuery 撈取大量的使用者 ID (約 150 萬筆)，經過一些欄位對應 (Mapping) 後，轉成特定格式的 JSON，最後上傳到合作夥伴的 API，同時備份一份資料回資料倉儲 (Data Warehouse)。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"原本的寫法非常直覺（或者說非常天真）："}]},{"type":"element","tag":"pre","props":{"code":"// ❌ 記憶體殺手寫法\nclass Uploader {\n  private data = []\n\n  handleRow(row) {\n    // 1. 把每一筆資料都塞進 Array\n    this.data.push(transform(row)) \n  }\n\n  async finish() {\n    // 2. 最後再一次轉成 JSON 字串\n    const jsonStr = JSON.stringify(this.data)\n    \n    // 3. 寫入檔案或上傳\n    await upload(jsonStr)\n  }\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// ❌ 記憶體殺手寫法\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" Uploader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" []\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"  handleRow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 1. 把每一筆資料都塞進 Array\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"push"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"transform"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" finish"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 2. 最後再一次轉成 JSON 字串\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" jsonStr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"stringify"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 3. 寫入檔案或上傳\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" upload"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"jsonStr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這段程式碼在處理 10 萬筆資料時可能只需要幾百 MB，但在處理 150 萬筆資料時，它在 Cloud Run (限制 2GB RAM) 上直接撞牆。"}]},{"type":"element","tag":"h2","props":{"id":"兇手是誰"},"children":[{"type":"text","value":"兇手是誰？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"看看這段 Crash 當下的 Log，V8 引擎發出了最後的哀號："}]},{"type":"element","tag":"pre","props":{"code":"[1:0x520d390] 927293 ms: Mark-sweep 974.6 (1042.3) -> 972.2 (1048.3) MB, 1854.6 / 0.0 ms (average mu = 0.661, current mu = 0.347) allocation failure; scavenge might not succeed\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[1:0x520d390] 927293 ms: Mark-sweep 974.6 (1042.3) -> 972.2 (1048.3) MB, 1854.6 / 0.0 ms (average mu = 0.661, current mu = 0.347) allocation failure; scavenge might not succeed\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這行 Log 告訴我們兩件事："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"GC 已經盡力了"}]},{"type":"text","value":"：Mark-sweep (老生代垃圾回收)"},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-1","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-1"},"children":[{"type":"text","value":"1"}]}]},{"type":"text","value":" 花了 1.8 秒，卻只回收了 2.4MB 的空間。這代表記憶體裡塞滿了「活著的物件」，GC 根本不敢動它們。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"兇手在 Stack Trace 裡"}]},{"type":"text","value":"：\n"},{"type":"element","tag":"pre","props":{"code":"v8::internal::JsonStringifier::SerializeString\nv8::internal::JsonStringify\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"v8::internal::JsonStringifier::SerializeString\nv8::internal::JsonStringify\n"}]}]},{"type":"text","value":"\n最後死在 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"JSON.stringify"}]},{"type":"text","value":"。"}]}]},{"type":"element","tag":"h3","props":{"id":"為什麼會這樣"},"children":[{"type":"text","value":"為什麼會這樣？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這裡有兩個 Node.js 的記憶體殺手在作祟："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"V8 物件的成本 (Object Overhead)"}]},{"type":"text","value":"\n一個簡單的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"{ \"id\": \"123\", \"val\": 1 }"}]},{"type":"text","value":" 在 JSON 字串裡可能只佔 20 bytes，但在 V8 的 Heap 裡，它需要儲存 Hidden Class、Properties、Pointers 等中繼資料，實際佔用可能是 100 bytes 以上。150 萬個小物件加起來，記憶體佔用非常可觀。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"字串拼接的災難"}]},{"type":"text","value":"\n當我們在大陣列上呼叫 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"JSON.stringify"}]},{"type":"text","value":" 時，V8 需要一塊"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"連續"}]},{"type":"text","value":"的記憶體空間來存放產生出來的巨大字串。如果你已經用了 1.5GB 的 Ram 存 Array，這時候又要跟系統要 500MB 來存字串，系統只能跟你說：辦不到。"}]}]},{"type":"element","tag":"h2","props":{"id":"解決方案空間不夠時間來湊"},"children":[{"type":"text","value":"解決方案：空間不夠，時間來湊"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"既然不能當「大胃王」一次把資料吃完再消化，那我們就改當「迴轉壽司」：來一盤，吃一盤。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們引入了 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Node.js Stream"}]},{"type":"text","value":" 的概念，搭配暫存檔案來解決這個問題。"}]},{"type":"element","tag":"h3","props":{"id":"改用串流寫入-stream-to-file"},"children":[{"type":"text","value":"改用串流寫入 (Stream to File)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"把原本的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Array.push"}]},{"type":"text","value":" 改成直接寫入 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"fs.createWriteStream"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"pre","props":{"code":"// ✅ 記憶體友善寫法\nimport * as fs from 'fs'\nimport * as os from 'os'\nimport * as path from 'path'\n\nclass Uploader {\n  private writer: fs.WriteStream\n  private filePath: string\n\n  constructor() {\n    // 建立一個指向暫存目錄的寫入流\n    this.filePath = path.join(os.tmpdir(), 'temp_data.json')\n    this.writer = fs.createWriteStream(this.filePath)\n  }\n\n  handleRow(row) {\n    const item = transform(row)\n    \n    // 1. 直接轉成 JSON 字串並寫入（NDJSON 格式）\n    this.writer.write(JSON.stringify(item) + '\\n')\n    \n    // 2. 這裡 item 已經沒用了，GC 下一次掃描時就可以把它回收掉！\n  }\n\n  async finish() {\n    await new Promise<void>(resolve => this.writer.end(resolve))\n    \n    // 3. 上傳這個檔案\n    await uploadToBigQuery(this.filePath)\n  }\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// ✅ 記憶體友善寫法\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" fs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'fs'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" os"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'os'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'path'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" Uploader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"fs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"WriteStream\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" filePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  constructor"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 建立一個指向暫存目錄的寫入流\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"filePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"join"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"os"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"tmpdir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"(), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'temp_data.json'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" fs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"createWriteStream"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"filePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"  handleRow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" transform"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 1. 直接轉成 JSON 字串並寫入（NDJSON 格式）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"write"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"stringify"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 2. 這裡 item 已經沒用了，GC 下一次掃描時就可以把它回收掉！\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" finish"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" Promise"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":">("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"end"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 3. 上傳這個檔案\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" uploadToBigQuery"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"filePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個改動帶來的差異是巨大的："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Before"}]},{"type":"text","value":": 記憶體隨著資料量線性成長 (O(N))，直到爆掉。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"After"}]},{"type":"text","value":": 記憶體維持在一個低水位 (O(1))，不管資料是 100 萬筆還是 1000 萬筆，記憶體用量幾乎不變。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"因為資料一寫進檔案 (Buffer) 後，JS 物件就沒人引用了，GC 可以隨時回收它們。"}]},{"type":"element","tag":"h2","props":{"id":"暫存檔案路徑的選擇"},"children":[{"type":"text","value":"暫存檔案路徑的選擇"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"你可能會想：「直接寫 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/tmp/temp_data.json"}]},{"type":"text","value":" 不就好了？」"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這樣寫在 Cloud Run 上確實可以跑，但如果你想在 Local 開發、測試，或者未來換到其他平台，就會出問題。"}]},{"type":"element","tag":"h3","props":{"id":"為什麼不能硬編碼-tmp"},"children":[{"type":"text","value":"為什麼不能硬編碼 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/tmp"}]},{"type":"text","value":"？"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"環境"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"暫存目錄"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Linux / Cloud Run"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/tmp"}]}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"macOS"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/var/folders/.../T"}]}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Windows"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"C:\\Users\\xxx\\AppData\\Local\\Temp"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果你硬編碼 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/tmp"}]},{"type":"text","value":"，在 Windows 上就會直接炸掉。"}]},{"type":"element","tag":"h3","props":{"id":"正確做法用-ostmpdir"},"children":[{"type":"text","value":"正確做法：用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"os.tmpdir()"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Node.js 提供了 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"os.tmpdir()"}]},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-2","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-2"},"children":[{"type":"text","value":"2"}]}]},{"type":"text","value":" 這個 API，會根據作業系統自動回傳正確的暫存目錄："}]},{"type":"element","tag":"pre","props":{"code":"import * as os from 'os'\nimport * as path from 'path'\n\n// ✅ 跨平台相容\nconst tempFilePath = path.join(os.tmpdir(), 'temp_data.json')\n\n// ❌ 只能在 Linux 上跑\nconst tempFilePath = '/tmp/temp_data.json'\n\n// ❌ 相對路徑，不是真正的暫存目錄\nconst tempFilePath = 'tmp/temp_data.json'\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" os"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'os'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" as"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" from"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'path'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// ✅ 跨平台相容\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" tempFilePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" path"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"join"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"os"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"tmpdir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"(), "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'temp_data.json'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// ❌ 只能在 Linux 上跑\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" tempFilePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '/tmp/temp_data.json'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// ❌ 相對路徑，不是真正的暫存目錄\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" tempFilePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" 'tmp/temp_data.json'\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這樣不管你在 macOS 開發、Linux 部署、還是未來換到 AWS Lambda，程式碼都不用改。"}]},{"type":"element","tag":"h2","props":{"id":"backpressurewritestream-的潛在問題"},"children":[{"type":"text","value":"Backpressure：WriteStream 的潛在問題"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"用 Stream 寫檔案時，有一個容易被忽略的問題："},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Backpressure（背壓）"}]},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-3","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-3"},"children":[{"type":"text","value":"3"}]}]},{"type":"text","value":"。"}]},{"type":"element","tag":"h3","props":{"id":"什麼是-backpressure"},"children":[{"type":"text","value":"什麼是 Backpressure？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"想像一個水管系統："}]},{"type":"element","tag":"pre","props":{"code":"[資料來源] → [buffer] → [磁碟寫入]\n   快速產生      暫存區      慢速消化\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[資料來源] → [buffer] → [磁碟寫入]\n   快速產生      暫存區      慢速消化\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"當資料產生速度 > 磁碟寫入速度時："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Buffer 持續堆積"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"記憶體越吃越多"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"最終還是 OOM"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"WriteStream.write()"}]},{"type":"text","value":" 會回傳一個 boolean："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"true"}]},{"type":"text","value":"：buffer 還有空間，繼續寫"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"false"}]},{"type":"text","value":"：buffer 滿了，應該暫停"}]}]},{"type":"element","tag":"h3","props":{"id":"目前的程式碼有問題嗎"},"children":[{"type":"text","value":"目前的程式碼有問題嗎？"}]},{"type":"element","tag":"pre","props":{"code":"// 目前的寫法：沒有檢查回傳值\nthis.writer.write(JSON.stringify(item) + '\\n')\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// 目前的寫法：沒有檢查回傳值\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"write"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"stringify"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"理論上應該這樣處理："}]},{"type":"element","tag":"pre","props":{"code":"const ok = this.writer.write(JSON.stringify(item) + '\\n')\nif (!ok) {\n  // 暫停，等 buffer 清空\n  await new Promise(resolve => this.writer.once('drain', resolve))\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" ok"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"write"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"stringify"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"ok"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 暫停，等 buffer 清空\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" Promise"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"writer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"once"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'drain'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"為什麼我選擇不處理"},"children":[{"type":"text","value":"為什麼我選擇不處理？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 Cloud Run 的環境下，"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/tmp"}]},{"type":"text","value":" 是 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"tmpfs"}]},{"type":"text","value":"（memory-backed filesystem），寫入速度幾乎等於記憶體速度。下游不會慢，所以 backpressure 問題不大。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"但如果你的環境是："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"傳統硬碟（HDD）"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"網路檔案系統（NFS）"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"寫入速度受限的雲端儲存"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"那就需要認真處理 backpressure 了。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"YAGNI 原則"}]},{"type":"text","value":"：先上線測試，真的遇到問題再處理。"}]},{"type":"element","tag":"h2","props":{"id":"意外發現的隱藏殺手"},"children":[{"type":"text","value":"意外發現的隱藏殺手"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在重構過程中，我還發現了原有程式碼的一個邏輯漏洞，這也是導致 OOM 的共犯。"}]},{"type":"element","tag":"pre","props":{"code":"private handleRow(row) {\n  const item = this.transform(row)\n  \n  // 原本的邏輯：先把資料塞進 Queue\n  this.rowQueue.push(item)\n  this.scheduleBatch() // 嘗試觸發上傳\n}\n\nprivate scheduleBatch() {\n  // ❌ 致命傷！\n  if (!this.sendToTarget) {\n    return \n  }\n  // ... 正常的上傳並清除 Queue 的邏輯\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" handleRow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"transform"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // 原本的邏輯：先把資料塞進 Queue\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"  this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"rowQueue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"push"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"  this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"scheduleBatch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// 嘗試觸發上傳\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" scheduleBatch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // ❌ 致命傷！\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"sendToTarget"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // ... 正常的上傳並清除 Queue 的邏輯\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個邏輯是說：如果 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"sendToTarget"}]},{"type":"text","value":" 是 false (例如我們只想跑備份不想真傳資料)，就不執行上傳。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"但問題是，"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"handleRow"}]},{"type":"text","value":" 會"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"無條件"}]},{"type":"text","value":"把資料塞進 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rowQueue"}]},{"type":"text","value":"，而清理 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rowQueue"}]},{"type":"text","value":" 的邏輯卻被 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"return"}]},{"type":"text","value":" 擋住了！這導致這 150 萬筆資料變成了「有進沒出」的死水，直接塞爆記憶體。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"修正這類 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Logical Memory Leak"}]},{"type":"text","value":" 比優化演算法更重要："}]},{"type":"element","tag":"pre","props":{"code":"private handleRow(row) {\n  const item = this.transform(row)\n  \n  // ✅ 修正：如果不打算送，一開始就不要塞進 Queue\n  if (this.sendToTarget) {\n    this.rowQueue.push(item)\n    this.scheduleBatch()\n  }\n  // ... 其他處理（例如寫入暫存檔）\n}\n","language":"typescript","meta":"","className":"language-typescript shiki shiki-themes one-dark-pro","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" handleRow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"transform"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // ✅ 修正：如果不打算送，一開始就不要塞進 Queue\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"sendToTarget"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"rowQueue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"push"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"scheduleBatch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  // ... 其他處理（例如寫入暫存檔）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"cloud-run-的設定誤區"},"children":[{"type":"text","value":"Cloud Run 的設定誤區"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最後一點，是關於 Cloud Run 的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Concurrency"}]},{"type":"text","value":" 設定"},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-4","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-4"},"children":[{"type":"text","value":"4"}]}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們原本的設定是："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Max instances: 10"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Concurrency (並行請求數): "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"80"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個設定把 Cloud Run 當成了 Web Server (處理輕量 API)。但我們的 Worker 是在處理「重型 ETL 任務」。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"試想，如果優化後單一請求需要 300MB，一個 Instance 確實可以跑得動了。但如果 Cloud Run 依照這設定，同時塞了 10 個 Request 給同一個 Instance？\n"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"300MB * 10 = 3GB"}]},{"type":"text","value":" -> "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"還是會爆"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"對於這種 Worker 類型的服務，我們把 Concurrency 降到了 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"，同時也升級了 Cloud Run 的記憶體。讓 Google 幫我們水平擴展 (開新機器)，而不是在同一台機器裡互搶資源。"}]},{"type":"element","tag":"h2","props":{"id":"總結"},"children":[{"type":"text","value":"總結"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這次的 OOM 事件讓我學到了幾件事："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"不要相信 Array"}]},{"type":"text","value":"：在 Node.js 處理大量數據時，Array 是最危險的資料結構。用完即丟，讓 GC 能回收。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Stream 是好朋友"}]},{"type":"text","value":"：善用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"fs.createWriteStream"}]},{"type":"text","value":"，用硬碟空間換取寶貴的記憶體空間。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"跨平台思維"}]},{"type":"text","value":"：用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"os.tmpdir()"}]},{"type":"text","value":" 而不是硬編碼 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/tmp"}]},{"type":"text","value":"，讓程式碼在任何環境都能跑。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"了解你的環境"}]},{"type":"text","value":"：Cloud Run 的 tmpfs 讓我們可以暫時忽略 backpressure，但換個環境可能就不行了。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"注意邏輯漏洞"}]},{"type":"text","value":"：有時候 OOM 不是演算法太爛，單純是你忘記清垃圾了。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"雲端思維"}]},{"type":"text","value":"：Serverless 環境資源有限，Concurrency 設定要根據任務類型調整。"}]}]},{"type":"element","tag":"section","props":{"className":["footnotes"],"dataFootnotes":""},"children":[{"type":"element","tag":"h2","props":{"className":["sr-only"],"id":"footnote-label"},"children":[{"type":"text","value":"Reference"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{"id":"user-content-fn-1"},"children":[{"type":"element","tag":"a","props":{"href":"https://v8.dev/blog/trash-talk","rel":["nofollow"]},"children":[{"type":"text","value":"Trash talk: the Orinoco garbage collector - V8"}]},{"type":"text","value":" - V8 官方部落格詳細說明了 Mark-sweep 等垃圾回收演算法的運作原理。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-1","ariaLabel":"Back to reference 1","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]},{"type":"element","tag":"li","props":{"id":"user-content-fn-2"},"children":[{"type":"element","tag":"a","props":{"href":"https://nodejs.org/api/os.html#ostmpdir","rel":["nofollow"]},"children":[{"type":"text","value":"OS | Node.js v22.x Documentation"}]},{"type":"text","value":" - "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"os.tmpdir()"}]},{"type":"text","value":" 會根據作業系統回傳預設的暫存目錄路徑。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-2","ariaLabel":"Back to reference 2","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]},{"type":"element","tag":"li","props":{"id":"user-content-fn-3"},"children":[{"type":"element","tag":"a","props":{"href":"https://nodejs.org/en/learn/modules/backpressuring-in-streams/","rel":["nofollow"]},"children":[{"type":"text","value":"Backpressuring in Streams - Node.js"}]},{"type":"text","value":" - Node.js 官方文件說明 Stream 中的 Backpressure 機制與處理方式。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-3","ariaLabel":"Back to reference 3","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]},{"type":"element","tag":"li","props":{"id":"user-content-fn-4"},"children":[{"type":"element","tag":"a","props":{"href":"https://cloud.google.com/run/docs/about-concurrency","rel":["nofollow"]},"children":[{"type":"text","value":"Maximum concurrent requests for services - Cloud Run"}]},{"type":"text","value":" - Google Cloud 官方文件說明 Cloud Run 的 Concurrency 設定與最佳實踐。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-4","ariaLabel":"Back to reference 4","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"案發經過","depth":2,"text":"案發經過"},{"id":"兇手是誰","depth":2,"text":"兇手是誰？","children":[{"id":"為什麼會這樣","depth":3,"text":"為什麼會這樣？"}]},{"id":"解決方案空間不夠時間來湊","depth":2,"text":"解決方案：空間不夠，時間來湊","children":[{"id":"改用串流寫入-stream-to-file","depth":3,"text":"改用串流寫入 (Stream to File)"}]},{"id":"暫存檔案路徑的選擇","depth":2,"text":"暫存檔案路徑的選擇","children":[{"id":"為什麼不能硬編碼-tmp","depth":3,"text":"為什麼不能硬編碼 /tmp？"},{"id":"正確做法用-ostmpdir","depth":3,"text":"正確做法：用 os.tmpdir()"}]},{"id":"backpressurewritestream-的潛在問題","depth":2,"text":"Backpressure：WriteStream 的潛在問題","children":[{"id":"什麼是-backpressure","depth":3,"text":"什麼是 Backpressure？"},{"id":"目前的程式碼有問題嗎","depth":3,"text":"目前的程式碼有問題嗎？"},{"id":"為什麼我選擇不處理","depth":3,"text":"為什麼我選擇不處理？"}]},{"id":"意外發現的隱藏殺手","depth":2,"text":"意外發現的隱藏殺手"},{"id":"cloud-run-的設定誤區","depth":2,"text":"Cloud Run 的設定誤區"},{"id":"總結","depth":2,"text":"總結"},{"id":"footnote-label","depth":2,"text":"Reference"}]}},"_type":"markdown","_id":"content:post:20260106-nodejs-oom-stream-optimization.md","_source":"content","_file":"post/20260106-nodejs-oom-stream-optimization.md","_extension":"md","createdAt":"2026-01-06T10:25:50.000Z","updatedAt":"2026-01-14T03:06:11.000Z"}