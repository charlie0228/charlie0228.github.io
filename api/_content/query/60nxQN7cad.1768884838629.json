{"_path":"/post/20260112-refactoring-data-flow-with-observer-pattern-typescript","_dir":"post","_draft":false,"_partial":false,"_locale":"","title":"使用 Observer Pattern 重構複雜的資料上傳流程 - 以 PrimaryAPI 與 BackupService 整合為例","description":"在後端開發中，我們常遇到需求不斷疊加，導致原本單純的類別（Class）變成了「上帝類別（God Class）」，職責混雜且難以測試。最近我在處理一個將資料上傳到 PrimaryAPI（主要資料平台）與 BackupService（備份服務）的功能時，就遇到了「堆疊式複雜度」的問題。本文將分享如何利用 Observer Pattern（觀察者模式）1 與 Mediator Pattern（中介者模式）2 來優化架構，達成高內聚低耦合的設計。","tags":"typescript, design-pattern, refactoring, nodejs, backend, observer-pattern","customCreatedAt":"2026-01-12T00:00:00.000Z","createdByAI":true,"readingTime":{"text":"8 min read","minutes":7.07,"time":424200,"words":1414},"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在後端開發中，我們常遇到需求不斷疊加，導致原本單純的類別（Class）變成了「上帝類別（God Class）」，職責混雜且難以測試。最近我在處理一個將資料上傳到 PrimaryAPI（主要資料平台）與 BackupService（備份服務）的功能時，就遇到了「堆疊式複雜度」的問題。本文將分享如何利用 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Observer Pattern（觀察者模式）"}]},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-1","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-1"},"children":[{"type":"text","value":"1"}]}]},{"type":"text","value":" 與 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Mediator Pattern（中介者模式）"}]},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-2","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-2"},"children":[{"type":"text","value":"2"}]}]},{"type":"text","value":" 來優化架構，達成高內聚低耦合的設計。"}]},{"type":"element","tag":"h2","props":{"id":"問題背景"},"children":[{"type":"text","value":"問題背景"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"原本的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StreamDataDriver"}]},{"type":"text","value":" 類別最初只負責「將資料分批上傳到 PrimaryAPI」。隨著業務需求增加，加入了以下邏輯："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"BackupService 資料備份"}]},{"type":"text","value":"：上傳 PrimaryAPI 的同時，要判斷資料是否符合 BackupService 格式。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入暫存檔"}]},{"type":"text","value":"：符合 BackupService 格式的資料要寫入暫存檔。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"上傳 BackupService"}]},{"type":"text","value":"：PrimaryAPI 上傳完成後，要把暫存檔上傳到 BackupService 平台。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"強順序性要求"}]},{"type":"text","value":"：如果 PrimaryAPI 上傳失敗，BackupService 流程必須全部中止，避免資料不一致。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這導致 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StreamDataDriver"}]},{"type":"text","value":" 裡充滿了與 PrimaryAPI 無關的程式碼（寫檔、判斷 ID 格式、呼叫其他上傳服務），違反了 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"單一職責原則 (Single Responsibility Principle, SRP)"}]},{"type":"element","tag":"sup","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#user-content-fn-3","ariaDescribedBy":["footnote-label"],"dataFootnoteRef":"","id":"user-content-fnref-3"},"children":[{"type":"text","value":"3"}]}]},{"type":"text","value":"。"}]},{"type":"element","tag":"pre","props":{"className":"language-typescript shiki shiki-themes one-dark-pro","code":"// 重構前的 God Class 示意\nclass StreamDataDriver {\n  execute() {\n    // 1. 讀取資料\n    stream.on('data', row => {\n       // 2. 處理 PrimaryAPI 上傳邏輯\n       buffer.push(row);\n       if (buffer.full) uploadToPrimary(buffer);\n\n       // 3. 處理 BackupService 邏輯 (混雜在一起!)\n       if (isBackupFormat(row)) {\n          writeToTempFile(row);\n       }\n    });\n\n    // 4. 等待所有流程結束，處理 BackupService 上傳\n    await Promise.all([primaryPromise, backupPromise]);\n  }\n}\n","language":"typescript","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// 重構前的 God Class 示意\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" StreamDataDriver"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"  execute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 1. 讀取資料\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"    stream"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"on"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#98C379"},"children":[{"type":"text","value":"'data'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"       // 2. 處理 PrimaryAPI 上傳邏輯\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"       buffer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"push"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"       if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"buffer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"full"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"uploadToPrimary"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"buffer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"       // 3. 處理 BackupService 邏輯 (混雜在一起!)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"       if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"isBackupFormat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"          writeToTempFile"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"       }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // 4. 等待所有流程結束，處理 BackupService 上傳\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" Promise"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"all"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"(["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"primaryPromise"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"backupPromise"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"]);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這樣的架構有幾個痛點："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"測試困難"}]},{"type":"text","value":"：要測試 PrimaryAPI 上傳邏輯，還得 Mock BackupService 的相關依賴。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"錯誤處理脆弱"}]},{"type":"text","value":"：並行執行下，很難精準控制「PrimaryAPI 失敗則 BackupService 不上傳」。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"擴充性差"}]},{"type":"text","value":"：如果明天要多傳一個 S3，程式碼會變得更亂。"}]}]},{"type":"element","tag":"h2","props":{"id":"解決方案observer-mediator"},"children":[{"type":"text","value":"解決方案：Observer + Mediator"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們決定將架構拆解，引入設計模式來分離職責。"}]},{"type":"element","tag":"h3","props":{"id":"_1-observer-pattern-觀察者模式"},"children":[{"type":"text","value":"1. Observer Pattern (觀察者模式)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先，我們將 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StreamDataDriver"}]},{"type":"text","value":" 降級為單純的 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Stream Driver"}]},{"type":"text","value":"（資料流驅動者）與 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"PrimaryAPI Uploader"}]},{"type":"text","value":"。它不再關心「誰要用這些資料」，只負責廣播「我處理到一筆資料囉」。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們定義了一個明確的介面："}]},{"type":"element","tag":"pre","props":{"className":"language-typescript shiki shiki-themes one-dark-pro","code":"// 定義監聽器的合約\nexport interface IDataListener {\n    onSchemaDetermined(schemaInfo: SchemaInfo): void\n    onRowProcessed(row: Record<string, any>, transformedItem: IDataItem): void\n}\n","language":"typescript","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// 定義監聽器的合約\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" interface"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" IDataListener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"    onSchemaDetermined"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"schemaInfo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"SchemaInfo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"void\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"    onRowProcessed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"Record"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"any"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":">, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"transformedItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"IDataItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"): "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"void\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"接著實作 BackupService 的專屬邏輯 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"BackupFileBuilder"}]},{"type":"text","value":"："}]},{"type":"element","tag":"pre","props":{"className":"language-typescript shiki shiki-themes one-dark-pro","code":"// 專門負責 BackupService 邏輯的觀察者\nexport class BackupFileBuilder implements IDataListener {\n    onRowProcessed(row: any, item: any) {\n        // 判斷是否符合 BackupService 規格\n        if (this.canWrite(row)) {\n            this.writeBackupFile(row, item);\n        }\n    }\n    // ... 其他寫檔邏輯\n}\n","language":"typescript","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"// 專門負責 BackupService 邏輯的觀察者\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" BackupFileBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" implements"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" IDataListener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"    onRowProcessed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"any"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"any"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        // 判斷是否符合 BackupService 規格\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"canWrite"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":")) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"            this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"writeBackupFile"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    // ... 其他寫檔邏輯\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StreamDataDriver"}]},{"type":"text","value":" 中，只需要一行程式碼通知大家："}]},{"type":"element","tag":"pre","props":{"className":"language-typescript shiki shiki-themes one-dark-pro","code":"class StreamDataDriver {\n    private listeners: IDataListener[] = [];\n\n    addListener(listener: IDataListener) {\n        this.listeners.push(listener);\n    }\n\n    private handleRow(row) {\n        // ... PrimaryAPI 處理邏輯 ...\n        \n        // 通知所有聽眾，完全不管他們要做什麼\n        this.listeners.forEach(l => l.onRowProcessed(row, item));\n    }\n}\n","language":"typescript","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" StreamDataDriver"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" listeners"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"IDataListener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"[] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" [];\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"    addListener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"listener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"IDataListener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"        this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"listeners"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"push"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"listener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" handleRow"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        // ... PrimaryAPI 處理邏輯 ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"        \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        // 通知所有聽眾，完全不管他們要做什麼\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"        this"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"listeners"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"forEach"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"l"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" l"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"onRowProcessed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"row"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"item"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"));\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"_2-mediator-pattern-中介者模式"},"children":[{"type":"text","value":"2. Mediator Pattern (中介者模式)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"雖然解耦了，但業務需求中的「強順序性（PrimaryAPI 成功 -> 才做 BackupService）」該由誰負責？這時候就需要一個 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Mediator（中介者）"}]},{"type":"text","value":"。在我們的案例中，由最外層的 Action Class ("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"TaskOrchestrator"}]},{"type":"text","value":") 擔任。"}]},{"type":"element","tag":"pre","props":{"className":"language-typescript shiki shiki-themes one-dark-pro","code":"class TaskOrchestrator {\n    async execute() {\n        // 1. 建立元件\n        const uploader = new StreamDataDriver();\n        const backupBuilder = new BackupFileBuilder();\n\n        // 2. 組裝 (註冊觀察者)\n        uploader.addListener(backupBuilder);\n\n        try {\n            // 3. 執行主流程 (PrimaryAPI 上傳)\n            await uploader.execute(); \n\n            // 4. 控制流程：只有 PrimaryAPI 成功，才繼續 BackupService\n            // 從 Builder 取得準備好的暫存檔路徑\n            const result = await backupBuilder.finish();\n            \n            if (result.count > 0) {\n                 await backupUploader.execute(result.filePath);\n            }\n\n        } catch (err) {\n            // 5. 統一錯誤處理與資源清理\n            backupBuilder.cleanup();\n            throw err;\n        }\n    }\n}\n","language":"typescript","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" TaskOrchestrator"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"    async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" execute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        // 1. 建立元件\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"        const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" uploader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" StreamDataDriver"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"        const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" backupBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":" BackupFileBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        // 2. 組裝 (註冊觀察者)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"        uploader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"addListener"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"backupBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"        try"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"            // 3. 執行主流程 (PrimaryAPI 上傳)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"            await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" uploader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"execute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"(); \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"            // 4. 控制流程：只有 PrimaryAPI 成功，才繼續 BackupService\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"            // 從 Builder 取得準備好的暫存檔路徑\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"            const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" result"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" backupBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"finish"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"            \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"            if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"result"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"count"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#56B6C2"},"children":[{"type":"text","value":" >"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D19A66"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"                 await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":" backupUploader"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"execute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"result"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"filePath"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"            }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"        } "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"catch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":"err"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#7F848E;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"            // 5. 統一錯誤處理與資源清理\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E5C07B"},"children":[{"type":"text","value":"            backupBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#61AFEF"},"children":[{"type":"text","value":"cleanup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C678DD"},"children":[{"type":"text","value":"            throw"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E06C75"},"children":[{"type":"text","value":" err"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#ABB2BF"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"新舊架構比較"},"children":[{"type":"text","value":"新舊架構比較"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":"left"},"children":[{"type":"text","value":"比較項目"}]},{"type":"element","tag":"th","props":{"align":"left"},"children":[{"type":"text","value":"舊架構 (Coupled / Parallel)"}]},{"type":"element","tag":"th","props":{"align":"left"},"children":[{"type":"text","value":"新架構 (Decoupled / Sequential)"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"責任歸屬"}]}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"混亂"}]},{"type":"text","value":"。Class 同時負責上傳、邏輯判斷、寫檔。"}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"單一職責"}]},{"type":"text","value":"。Uploader 管上傳；Builder 管資料準備；Action 管流程。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"錯誤處理"}]}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"脆弱"}]},{"type":"text","value":"。PrimaryAPI 失敗時難以中斷 BackupService 流程。"}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"強健"}]},{"type":"text","value":"。由 Mediator 統一控制，失敗直接跳過後續步驟。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"擴充性"}]}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"低"}]},{"type":"text","value":"。新增功能需修改核心程式碼。"}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"高"}]},{"type":"text","value":"。只需新增 Listener 即可。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"測試難易度"}]}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"難"}]},{"type":"text","value":"。依賴過多，Mock 困難。"}]},{"type":"element","tag":"td","props":{"align":"left"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"易"}]},{"type":"text","value":"。各個元件可獨立單元測試。"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"技術反思前端-vs-後端思維"},"children":[{"type":"text","value":"技術反思：前端 vs 後端思維"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"身為前端開發者轉戰後端，可能會覺得這種設計「參數傳來傳去很麻煩」或是「為什麼不直接寫在裡面就好」。但這正是後端開發與前端元件化思維的異曲同工之妙："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Listener"}]},{"type":"text","value":" 其實就像 React 的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"props.onEvent"}]},{"type":"text","value":" 或 Vue 的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$emit"}]},{"type":"text","value":"。讓元件只負責發出訊號，而不負責處理後續。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Dependency Injection (DI)"}]},{"type":"text","value":" 就像是把 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"logger"}]},{"type":"text","value":" 或 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"config"}]},{"type":"text","value":" 當作 props 傳進元件，讓元件保持純粹，方便測試。"}]}]},{"type":"element","tag":"h2","props":{"id":"總結"},"children":[{"type":"text","value":"總結"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這次重構展示了即使在業務邏輯強相依（Sequential constraint）的情況下，依然可以透過 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Observer Pattern"}]},{"type":"text","value":" 實現程式碼層級的解耦。我們保留了 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"StreamDataDriver"}]},{"type":"text","value":" 作為資料流驅動者，利用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"listeners"}]},{"type":"text","value":" 陣列保留擴充性，最後透過外層的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"Mediator"}]},{"type":"text","value":" 來確保業務邏輯的執行順序。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這樣的架構不僅讓目前的程式碼更乾淨，也為未來可能新增的「S3 備份」、「Log 監控」等功能預留了極佳的擴充空間。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"延伸閱讀："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612","rel":["nofollow"]},"children":[{"type":"text","value":"Design Patterns: Elements of Reusable Object-Oriented Software"}]},{"type":"text","value":" - Gang of Four (Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides) 於 1994 年出版的經典著作，定義了 23 種設計模式。"}]}]},{"type":"element","tag":"section","props":{"className":["footnotes"],"dataFootnotes":""},"children":[{"type":"element","tag":"h2","props":{"className":["sr-only"],"id":"footnote-label"},"children":[{"type":"text","value":"Reference"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{"id":"user-content-fn-1"},"children":[{"type":"element","tag":"a","props":{"href":"https://gameprogrammingpatterns.com/observer.html","rel":["nofollow"]},"children":[{"type":"text","value":"Observer Pattern - Game Programming Patterns"}]},{"type":"text","value":" - Observer Pattern 是 Gang of Four 定義的 23 種設計模式之一，屬於行為型模式，定義物件間的一對多依賴關係。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-1","ariaLabel":"Back to reference 1","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]},{"type":"element","tag":"li","props":{"id":"user-content-fn-2"},"children":[{"type":"element","tag":"a","props":{"href":"https://springframework.guru/gang-of-four-design-patterns/mediator-pattern/","rel":["nofollow"]},"children":[{"type":"text","value":"Mediator Pattern - Spring Framework Guru"}]},{"type":"text","value":" - Mediator Pattern 透過中介者物件封裝物件間的互動，促進鬆耦合設計。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-2","ariaLabel":"Back to reference 2","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]},{"type":"element","tag":"li","props":{"id":"user-content-fn-3"},"children":[{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Single-responsibility_principle","rel":["nofollow"]},"children":[{"type":"text","value":"Single-responsibility principle - Wikipedia"}]},{"type":"text","value":" - Robert C. Martin 提出的 SOLID 原則之一，主張一個類別應該只有一個改變的理由。 "},{"type":"element","tag":"a","props":{"href":"#user-content-fnref-3","ariaLabel":"Back to reference 3","className":["data-footnote-backref"],"dataFootnoteBackref":""},"children":[{"type":"text","value":"↩"}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"問題背景","depth":2,"text":"問題背景"},{"id":"解決方案observer-mediator","depth":2,"text":"解決方案：Observer + Mediator","children":[{"id":"_1-observer-pattern-觀察者模式","depth":3,"text":"1. Observer Pattern (觀察者模式)"},{"id":"_2-mediator-pattern-中介者模式","depth":3,"text":"2. Mediator Pattern (中介者模式)"}]},{"id":"新舊架構比較","depth":2,"text":"新舊架構比較"},{"id":"技術反思前端-vs-後端思維","depth":2,"text":"技術反思：前端 vs 後端思維"},{"id":"總結","depth":2,"text":"總結"},{"id":"footnote-label","depth":2,"text":"Reference"}]}},"_type":"markdown","_id":"content:post:20260112-refactoring-data-flow-with-observer-pattern-typescript.md","_source":"content","_file":"post/20260112-refactoring-data-flow-with-observer-pattern-typescript.md","_extension":"md","createdAt":"2026-01-12T08:23:38.000Z","updatedAt":"2026-01-14T03:06:11.000Z"}